<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tram Tracker – Lines 1-8</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  body, html { height: 100%; margin: 0; padding: 0; }
  #map { width: 100%; height: 100%; }

  /* Pizza slice arrow shape */
  .arrow-outer {
    width: 40px;
    height: 40px;
    background: #D50000;
    display: flex;
    justify-content: center;
    align-items: flex-end;
    clip-path: polygon(
      50% 0%,      /* tip */
      90% 80%,     /* right corner */
      80% 100%,    /* right crust edge */
      20% 100%,    /* left crust edge */
      10% 80%      /* left corner */
    );
    position: relative;
  }

  /* Circle version for stationary trams */
  .arrow-outer.circle {
    clip-path: circle(40% at 50% 50%);
    align-items: center;
    justify-content: center;
  }

  .arrow-inner {
    width: 30px;
    height: 30px;
    transform: rotate(0deg); /* keep number upright */
  }

  /* Toggle buttons container */
  #tram-toggle {
    position: absolute;
    top: 10px;
    left: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    z-index: 1000;
  }

  .toggle-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: 2px solid black;
    background: white;
    padding: 0;
    user-select: none;
  }

  .toggle-btn img {
    width: 32px;
    height: 32px;
  }
</style>
</head>
<body>

<div id="map"></div>
<div id="tram-toggle"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map', { zoomControl: false }).setView([47.07, 21.92], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '© OpenStreetMap contributors'
}).addTo(map);

let currentMarkers = [];
const previousPositions = {};
const previousRotations = {};
const initialRotations = {};
const MIN_MOVE = 0.00001;
const visibleLines = {1:true,2:true,3:true,4:true,5:true,6:true,7:true,8:true};

// Tram icons
const tramIcons = {
  "1": "https://cdn-icons-png.flaticon.com/512/8068/8068017.png",
  "2": "https://cdn-icons-png.flaticon.com/512/8068/8068073.png",
  "3": "https://cdn-icons-png.flaticon.com/512/8068/8068129.png",
  "4": "https://cdn-icons-png.flaticon.com/512/8068/8068184.png",
  "5": "https://cdn-icons-png.flaticon.com/512/8068/8068238.png",
  "6": "https://cdn-icons-png.flaticon.com/512/8068/8068292.png",
  "7": "https://cdn-icons-png.flaticon.com/512/8068/8068348.png",
  "8": "https://cdn-icons-png.flaticon.com/512/8068/8068393.png",
};

// Create toggle buttons
const toggleDiv = document.getElementById('tram-toggle');
for(let i=1;i<=8;i++){
  const btn = document.createElement('div');
  btn.className = 'toggle-btn';
  btn.dataset.line = i;

  const img = document.createElement('img');
  img.src = tramIcons[i];
  btn.appendChild(img);

  btn.onclick = () => {
    visibleLines[i] = !visibleLines[i];
    btn.style.opacity = visibleLines[i] ? '1' : '0.4';
  };
  toggleDiv.appendChild(btn);
}

async function updateTrams() {
  try {
    currentMarkers.forEach(marker => map.removeLayer(marker));
    currentMarkers = [];

    const proxy = "https://corsproxy.io/?";

    for (let line=1; line<=8; line++) {
      if (!visibleLines[line]) continue;

      const apiUrl = `https://www.otlra.ro/templates/cassiopeia/php/get_vehicles_xml.php?line=${line}`;
      const response = await fetch(proxy + apiUrl);
      const trams = await response.json();

      trams.forEach(tram => {
        const lat = parseFloat(tram.lat);
        const lng = parseFloat(tram.lng);
        const match = tram.title.match(/Cod:\s*(\d+)/i);
        const tramCode = match ? match[1] : "unknown";

        let rotation = previousRotations[tramCode] || 0;
        if (!(tramCode in initialRotations)) initialRotations[tramCode] = true;

        if (previousPositions[tramCode]) {
          const prev = previousPositions[tramCode];
          const dx = lng - prev.lng;
          const dy = lat - prev.lat;
          const distance = Math.sqrt(dx*dx + dy*dy);

          if (distance >= MIN_MOVE) {
            rotation = (- Math.atan2(dy, dx) * (180 / Math.PI) + 90);
            previousRotations[tramCode] = rotation;
            initialRotations[tramCode] = false; // tram moved
          }
        }

        previousPositions[tramCode] = { lat, lng };

        const iconUrl = tramIcons[line] || tramIcons["1"];
        const isCircle = initialRotations[tramCode]; // still initial
        const tramIcon = L.divIcon({
          className: "",
          html: `
            <div class="arrow-outer ${isCircle ? 'circle' : ''}" style="${!isCircle ? 'transform: rotate('+rotation+'deg);' : ''}">
              <img class="arrow-inner" src="${iconUrl}" />
            </div>
          `,
          iconSize: [36,36],
          iconAnchor: [18,18],
          popupAnchor: [0,-18]
        });

        const marker = L.marker([lat,lng], {icon: tramIcon})
          .bindPopup(tram.title)
          .addTo(map);

        currentMarkers.push(marker);
      });
    }

  } catch(err) {
    console.error("Failed to update trams:", err);
  }
}
// Show user location
map.locate({setView: true, maxZoom: 16, watch: true});

let myMarker = null;
map.on('locationfound', (e) => {
  const latlng = e.latlng;
  if (!myMarker) {
    myMarker = L.circleMarker(latlng, {
      radius: 8,
      color: '#1976D2',
      fillColor: '#1976D2',
      fillOpacity: 0.8
    }).addTo(map).bindPopup("You are here");
  } else {
    myMarker.setLatLng(latlng);
  }
});

map.on('locationerror', (err) => {
  console.warn("Location not available:", err.message);
});

updateTrams();
setInterval(updateTrams, 10000);
</script>
</body>
</html>
