<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Oradea Trams Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    const map = L.map('map').setView([47.07, 21.92], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const tramMarkers = {}; // stores markers by tram ID

    async function updateTrams() {
      const proxy = "https://corsproxy.io/?";
      const baseUrl = "https://www.otlra.ro/templates/cassiopeia/php/get_vehicles_xml.php?line=";
      const seenIds = new Set();

      try {
        // fetch all tram lines in parallel
        const promises = [];
        for (let line = 1; line <= 8; line++) {
          promises.push(fetch(proxy + baseUrl + line).then(r => r.json()).catch(() => []));
        }

        // wait for all results
        const allResults = await Promise.all(promises);
        const allTrams = allResults.flat(); // flatten into one array

        // update markers
        allTrams.forEach(tram => {
          const id = tram.id;
          seenIds.add(id);
          const lat = parseFloat(tram.lat);
          const lng = parseFloat(tram.lng);
          const title = tram.title;

          if (tramMarkers[id]) {
            tramMarkers[id].setLatLng([lat, lng]);
          } else {
            const marker = L.marker([lat, lng]).bindPopup(`<b>${title}</b>`);
            marker.addTo(map);
            tramMarkers[id] = marker;
          }
        });

        // remove trams that disappeared
        for (let id in tramMarkers) {
          if (!seenIds.has(id)) {
            map.removeLayer(tramMarkers[id]);
            delete tramMarkers[id];
          }
        }

      } catch (err) {
        console.error("Failed to update trams:", err);
      }
    }

    // load immediately, then update every 10s
    updateTrams();
    setInterval(updateTrams, 10000);
  </script>
</body>
</html>
