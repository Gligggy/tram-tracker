<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tram Tracker – Lines 1-8</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body, html {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #map {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Initialize map
    const map = L.map('map').setView([47.07, 21.92], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Store all current markers to remove them each update
    let currentMarkers = [];

    // Tram number → icon mapping (set your own image URLs here)
    const tramIcons = {
      "1": "https://cdn-icons-png.flaticon.com/512/8068/8068017.png",
      "2": "https://cdn-icons-png.flaticon.com/512/8068/8068073.png",
      "3": "https://cdn-icons-png.flaticon.com/512/8068/8068129.png",
      "4": "https://cdn-icons-png.flaticon.com/512/8068/8068184.png",
      "5": "https://cdn-icons-png.flaticon.com/512/8068/8068238.png",
      "6": "https://cdn-icons-png.flaticon.com/512/8068/8068292.png",
      "7": "https://cdn-icons-png.flaticon.com/512/8068/8068348.png",
      "8": "https://cdn-icons-png.flaticon.com/512/8068/8068393.png",
    };

    // Function to fetch and display all trams
    async function updateTrams() {
      try {
        // Remove all old markers
        currentMarkers.forEach(marker => map.removeLayer(marker));
        currentMarkers = [];

        const proxy = "https://corsproxy.io/?";

        // Fetch all lines 1-8
        for (let line = 1; line <= 8; line++) {
          const apiUrl = `https://www.otlra.ro/templates/cassiopeia/php/get_vehicles_xml.php?line=${line}`;
          const response = await fetch(proxy + apiUrl);
          const trams = await response.json();

          trams.forEach(tram => {
            const lat = parseFloat(tram.lat);
            const lng = parseFloat(tram.lng);
            
            // Extract the tram number from the title (e.g., "Cod: 44T" → "44T")
            const match = tram.title.match(/Cod:\s*(\d+)/i);
            const tramNumber = match ? match[1] : line; // fallback to line if not found

            // Choose icon URL based on tram number
            const iconUrl = tramIcons[tramNumber] || tramIcons[line] || tramIcons["1"];

            const tramIcon = L.icon({
              iconUrl: iconUrl,
              iconSize: [36, 36],
              iconAnchor: [18, 18],
              popupAnchor: [0, -18]
            });

            const marker = L.marker([lat, lng], { icon: tramIcon })
              .bindPopup(tram.title)
              .addTo(map);

            currentMarkers.push(marker);
          });
        }
      } catch (err) {
        console.error("Failed to update trams:", err);
      }
    }

    // Initial load and refresh every 10 seconds
    updateTrams();
    setInterval(updateTrams, 10000);
  </script>
</body>
</html>
