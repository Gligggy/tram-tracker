<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tram Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; width: 100vw; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Initialize the map
    const map = L.map('map').setView([47.0707, 21.9213], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    const tramMarkers = {}; // Track markers by tram ID

    async function updateTrams() {
      try {
        const proxy = "https://corsproxy.io/?"; // Bypass CORS
        const apiUrl = "https://www.otlra.ro/templates/cassiopeia/php/get_vehicles_xml.php?line=3";

        const response = await fetch(proxy + apiUrl);
        const trams = await response.json();

        const seenIds = new Set();

        trams.forEach(tram => {
          const lat = parseFloat(tram.lat);
          const lng = parseFloat(tram.lng);
          seenIds.add(tram.id);

          if (tramMarkers[tram.id]) {
            // Update existing marker
            tramMarkers[tram.id].setLatLng([lat, lng]);
          } else {
            // Create new marker
            const marker = L.marker([lat, lng])
              .bindPopup(tram.title)
              .addTo(map);
            tramMarkers[tram.id] = marker;
          }
        });

        // Remove markers no longer in API
        for (let id in tramMarkers) {
          if (!seenIds.has(id)) {
            map.removeLayer(tramMarkers[id]);
            delete tramMarkers[id];
          }
        }

      } catch (err) {
        console.error("Failed to update trams:", err);
      }
    }

    // Initial update
    updateTrams();

    // Update every 5 seconds
    setInterval(updateTrams, 5000);
  </script>
</body>
</html>
